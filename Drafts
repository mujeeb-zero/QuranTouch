index.tsx

import { Ionicons } from '@expo/vector-icons';
import AsyncStorage from '@react-native-async-storage/async-storage'; // ğŸ’¾ IMPORT STORAGE
import { useFonts } from 'expo-font';
import { useFocusEffect, useRouter } from 'expo-router'; // ğŸ”„ Added useFocusEffect
import React, { useCallback, useState } from 'react';
import { FlatList, Platform, SafeAreaView, StatusBar, StyleSheet, Text, TextInput, TouchableOpacity, View } from 'react-native';

const SURAH_LIST = [
Â  { id: 1, nameAr: 'Ø§Ù„ÙØ§ØªØ­Ø©', nameEn: 'Al-Fatiha', meaning: 'The Opening', verses: 7 },
Â  { id: 2, nameAr: 'Ø§Ù„Ø¨Ù‚Ø±Ø©', nameEn: 'Al-Baqarah', meaning: 'The Cow', verses: 286 },
Â  { id: 3, nameAr: 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', nameEn: 'Ali Imran', meaning: 'Family of Imran', verses: 200 },
Â  { id: 18, nameAr: 'Ø§Ù„ÙƒÙ‡Ù', nameEn: 'Al-Kahf', meaning: 'The Cave', verses: 110 },
Â  { id: 36, nameAr: 'ÙŠØ³', nameEn: 'Ya-Sin', meaning: 'Ya Sin', verses: 83 },
Â  { id: 55, nameAr: 'Ø§Ù„Ø±Ø­Ù…Ù†', nameEn: 'Ar-Rahman', meaning: 'The Beneficent', verses: 78 },
Â  { id: 67, nameAr: 'Ø§Ù„Ù…Ù„Ùƒ', nameEn: 'Al-Mulk', meaning: 'The Sovereignty', verses: 30 },
Â  { id: 112, nameAr: 'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ', nameEn: 'Al-Ikhlas', meaning: 'The Sincerity', verses: 4 },
Â  { id: 113, nameAr: 'Ø§Ù„ÙÙ„Ù‚', nameEn: 'Al-Falaq', meaning: 'The Daybreak', verses: 5 },
Â  { id: 114, nameAr: 'Ø§Ù„Ù†Ø§Ø³', nameEn: 'An-Nas', meaning: 'Mankind', verses: 6 },
];

const COLORS = {
Â  background: '#FDFBF7', text: '#2D2D2D', primary: '#BFA868',
Â  cardBg: '#FFFFFF', border: '#F2E8D5', subText: '#888888',
Â  lastReadBg: '#2D2D2D', lastReadText: '#BFA868'
};

export default function HomeScreen() {
Â  const router = useRouter();
Â  const [searchQuery, setSearchQuery] = useState('');
Â  const [lastRead, setLastRead] = useState(null); // ğŸ”„ State for loaded data

Â  const [fontsLoaded] = useFonts({
Â  Â  'AlMushaf': require('../../assets/fonts/AlMushaf.ttf'),
Â  Â  'AlmendraSC': require('../../assets/fonts/AlmendraSC.ttf'),
Â  });

Â  // ğŸ”„ LOAD PROGRESS EVERY TIME SCREEN IS FOCUSED
Â  useFocusEffect(
Â  Â  useCallback(() => {
Â  Â  Â  const loadProgress = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const saved = await AsyncStorage.getItem('last_read');
Â  Â  Â  Â  Â  if (saved) {
Â  Â  Â  Â  Â  Â  setLastRead(JSON.parse(saved));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) { console.log('Failed to load', e); }
Â  Â  Â  };
Â  Â  Â  loadProgress();
Â  Â  }, [])
Â  );

Â  if (!fontsLoaded) return <View style={styles.container} />;

Â  const filteredSurahs = SURAH_LIST.filter(item => {
Â  Â  const q = searchQuery.toLowerCase();
Â  Â  return (
Â  Â  Â  item.nameEn.toLowerCase().includes(q) ||
Â  Â  Â  item.id.toString().includes(q) ||
Â  Â  Â  item.nameAr.includes(q)
Â  Â  );
Â  });

Â  const renderItem = ({ item }) => (
Â  Â  <TouchableOpacity
Â  Â  Â  style={styles.card}
Â  Â  Â  activeOpacity={0.6}
Â  Â  Â  onPress={() => {
Â  Â  Â  Â  if (item.id === 1 || item.id === 2) {
Â  Â  Â  Â  Â  router.push({ pathname: '/player', params: { surahId: item.id } });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert('Audio coming soon!');
Â  Â  Â  Â  }
Â  Â  Â  }}
Â  Â  >
Â  Â  Â  <View style={styles.numberContainer}>
Â  Â  Â  Â  <View style={styles.numberCircle}>
Â  Â  Â  Â  Â  <Text style={styles.numberText}>{item.id}</Text>
Â  Â  Â  Â  </View>
Â  Â  Â  </View>
Â  Â  Â  <View style={styles.infoBox}>
Â  Â  Â  Â  <Text style={styles.nameEn}>{item.nameEn}</Text>
Â  Â  Â  Â  <Text style={styles.meaning}>{item.meaning} â€¢ {item.verses} Verses</Text>
Â  Â  Â  </View>
Â  Â  Â  <View style={styles.arabicBox}>
Â  Â  Â  Â  <Text style={styles.nameAr}>{item.nameAr}</Text>
Â  Â  Â  </View>
Â  Â  </TouchableOpacity>
Â  );

Â  return (
Â  Â  <SafeAreaView style={styles.container}>
Â  Â  Â  <StatusBar barStyle="dark-content" />

Â  Â  Â  <View style={styles.header}>
Â  Â  Â  Â  <View style={styles.headerDecoration} />
Â  Â  Â  Â  <Text style={styles.headerTitle}>THE NOBLE QURAN</Text>
Â  Â  Â  Â  <Text style={styles.headerSubtitle}>Select a Surah to Recite</Text>
Â  Â  Â  Â  <View style={styles.headerDecoration} />
Â  Â  Â  </View>

Â  Â  Â  {/* SEARCH BAR */}
Â  Â  Â  <View style={styles.searchContainer}>
Â  Â  Â  Â  <Ionicons name="search" size={20} color={COLORS.primary} style={styles.searchIcon} />
Â  Â  Â  Â  <TextInput
Â  Â  Â  Â  Â  style={styles.searchInput}
Â  Â  Â  Â  Â  placeholder="Search by Name or Number..."
Â  Â  Â  Â  Â  placeholderTextColor="#999"
Â  Â  Â  Â  Â  value={searchQuery}
Â  Â  Â  Â  Â  onChangeText={setSearchQuery}
Â  Â  Â  Â  />
Â  Â  Â  Â  {searchQuery.length > 0 && (
Â  Â  Â  Â  Â  <TouchableOpacity onPress={() => setSearchQuery('')}>
Â  Â  Â  Â  Â  Â  <Ionicons name="close-circle" size={20} color="#CCC" />
Â  Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  )}
Â  Â  Â  </View>

Â  Â  Â  {/* âœ¨ REAL LAST PLAYED BOX */}
Â  Â  Â  {lastRead && (
Â  Â  Â  Â  <TouchableOpacity
Â  Â  Â  Â  Â  style={styles.lastReadCard}
Â  Â  Â  Â  Â  activeOpacity={0.8}
Â  Â  Â  Â  Â  onPress={() => {
Â  Â  Â  Â  Â  Â  router.push({
Â  Â  Â  Â  Â  Â  Â  pathname: '/player',
Â  Â  Â  Â  Â  Â  Â  params: {
Â  Â  Â  Â  Â  Â  Â  Â  surahId: lastRead.surahId,
Â  Â  Â  Â  Â  Â  Â  Â  initialAyah: lastRead.verseId
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  <View>
Â  Â  Â  Â  Â  Â  <Text style={styles.lastReadLabel}>CONTINUE READING</Text>
Â  Â  Â  Â  Â  Â  <Text style={styles.lastReadTitle}>{lastRead.nameEn}</Text>
Â  Â  Â  Â  Â  Â  <Text style={styles.lastReadAyah}>Ayah {lastRead.ayahDisplay}</Text>
Â  Â  Â  Â  Â  </View>
Â  Â  Â  Â  Â  <Ionicons name="play-circle" size={40} color={COLORS.primary} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  )}

Â  Â  Â  {/* LIST */}
Â  Â  Â  <FlatList
Â  Â  Â  Â  data={filteredSurahs}
Â  Â  Â  Â  keyExtractor={(item) => item.id.toString()}
Â  Â  Â  Â  renderItem={renderItem}
Â  Â  Â  Â  contentContainerStyle={styles.listContent}
Â  Â  Â  Â  showsVerticalScrollIndicator={false}
Â  Â  Â  />
Â  Â  </SafeAreaView>
Â  );
}

const styles = StyleSheet.create({
Â  container: { flex: 1, backgroundColor: COLORS.background },
Â  header: { paddingVertical: 20, alignItems: 'center', backgroundColor: COLORS.background },
Â  headerTitle: { fontFamily: 'AlmendraSC', fontSize: 26, color: COLORS.primary, letterSpacing: 1 },

Â  lastReadCard: {
Â  Â  backgroundColor: COLORS.lastReadBg,
Â  Â  marginHorizontal: 20,
Â  Â  marginBottom: 15,
Â  Â  borderRadius: 12,
Â  Â  padding: 20,
Â  Â  flexDirection: 'row',
Â  Â  justifyContent: 'space-between',
Â  Â  alignItems: 'center',
Â  Â  shadowColor: "#000", shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.3, shadowRadius: 5, elevation: 5,
Â  },
Â  lastReadLabel: { color: '#888', fontSize: 10, letterSpacing: 1, marginBottom: 5 },
Â  lastReadTitle: { color: COLORS.primary, fontFamily: 'AlmendraSC', fontSize: 20 },
Â  lastReadAyah: { color: '#FFF', fontSize: 12, marginTop: 2 },

Â  searchContainer: {
Â  Â  flexDirection: 'row', alignItems: 'center', backgroundColor: '#FFF',
Â  Â  marginHorizontal: 20, marginBottom: 15, paddingHorizontal: 15, height: 50,
Â  Â  borderRadius: 25, borderWidth: 1, borderColor: COLORS.primary,
Â  Â  shadowColor: "#BFA868", shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.1, shadowRadius: 5, elevation: 2,
Â  },
Â  searchIcon: { marginRight: 10 },
Â  searchInput: {
Â  Â  flex: 1,
Â  Â  fontSize: 16,
Â  Â  color: '#333',
Â  Â  fontFamily: Platform.OS === 'ios' ? 'System' : 'Roboto',
Â  Â  height: '100%',
Â  Â  ...Platform.select({ web: { outlineStyle: 'none' } })
Â  },

Â  headerSubtitle: {
Â  Â  fontSize: 12,
Â  Â  color: COLORS.subText,
Â  Â  marginTop: 4,
Â  Â  textTransform: 'uppercase',
Â  Â  letterSpacing: 2,
Â  },

Â  listContent: { padding: 20, paddingTop: 0 },
Â  card: { flexDirection: 'row', alignItems: 'center', backgroundColor: COLORS.cardBg, paddingVertical: 18, paddingHorizontal: 16, borderRadius: 8, marginBottom: 12, shadowColor: "#BFA868", shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.1, shadowRadius: 10, elevation: 3, borderWidth: 1, borderColor: 'rgba(191, 168, 104, 0.2)' },
Â  numberContainer: { justifyContent: 'center', alignItems: 'center', marginRight: 16 },
Â  numberCircle: { width: 38, height: 38, borderRadius: 19, backgroundColor: '#FFF', justifyContent: 'center', alignItems: 'center', borderWidth: 1.5, borderColor: COLORS.primary },
Â  numberText: { fontFamily: 'AlmendraSC', fontSize: 18, color: COLORS.primary },
Â  infoBox: { flex: 1, justifyContent: 'center' },
Â  nameEn: { fontFamily: 'AlmendraSC', fontSize: 18, color: COLORS.text, marginBottom: 2 },
Â  meaning: { fontSize: 12, color: COLORS.subText, fontWeight: '500' },
Â  arabicBox: { justifyContent: 'center', alignItems: 'flex-end' },
Â  nameAr: { fontFamily: 'AlMushaf', fontSize: 26, color: COLORS.text, marginTop: 4 },
});

player.tsx

import { Ionicons } from '@expo/vector-icons';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Audio } from 'expo-av';
import { useFonts } from 'expo-font';
import { Stack, useLocalSearchParams, useRouter } from 'expo-router';
import React, { useEffect, useRef, useState } from 'react';
import { PanResponder, SafeAreaView, ScrollView, StyleSheet, Text, TouchableOpacity, View } from 'react-native';
import { getSurahData } from '../data/registry';

// ğŸ¨ THEMES
const LIGHT_THEME = {
Â  background: '#FDFBF7', text: '#2D2D2D', primary: '#BFA868', Â  Â 
Â  highlight: '#FFF9E6', timelineBase: '#E0E0E0', timelineFill: '#BFA868',
Â  secondaryText: '#888888', brackets: '#BFA868', controlBg: '#FFF'
};

const DARK_THEME = {
Â  background: '#121212', text: '#E0E0E0', primary: '#D4AF37', Â  Â 
Â  highlight: '#2A2A2A', timelineBase: '#333333', timelineFill: '#D4AF37',
Â  secondaryText: '#888888', brackets: '#D4AF37', controlBg: '#1E1E1E'
};

const AyahTimeline = ({ ayah, currentPosition, onSeek, colors }) => {
Â  const duration = ayah.end - ayah.start;
Â  if (duration <= 0) return null;Â 
Â  let localProgress = 0;
Â  if (currentPosition >= ayah.end) localProgress = 1;Â 
Â  else if (currentPosition <= ayah.start) localProgress = 0;Â 
Â  else localProgress = (currentPosition - ayah.start) / duration;
Â Â 
Â  const viewRef = useRef(null);Â 
Â  const timelineLayout = useRef({ x: 0, width: 0 });
Â  const handleTouch = (touchX) => {
Â  Â  const { width, x } = timelineLayout.current;
Â  Â  if (width === 0) return;
Â  Â  let percent = (touchX - x) / width;
Â  Â  percent = 1 - percent;Â 
Â  Â  if (percent < 0) percent = 0;
Â  Â  if (percent > 1) percent = 1;
Â  Â  onSeek(ayah.start + (percent * duration));
Â  };
Â  const panResponder = useRef(
Â  Â  PanResponder.create({
Â  Â  Â  onStartShouldSetPanResponder: () => true,
Â  Â  Â  onPanResponderGrant: (evt) => handleTouch(evt.nativeEvent.pageX),
Â  Â  Â  onPanResponderMove: (evt) => handleTouch(evt.nativeEvent.pageX),
Â  Â  })
Â  ).current;
Â  return (
Â  Â  <View style={styles.timelineWrapper}>
Â  Â  Â  <View ref={viewRef} style={styles.trackArea}
Â  Â  Â  Â  onLayout={() => { if (viewRef.current) { viewRef.current.measure((x, y, width, height, pageX, pageY) => { timelineLayout.current = { x: pageX, width: width }; }); } }}
Â  Â  Â  Â  {...panResponder.panHandlers}
Â  Â  Â  >
Â  Â  Â  Â  <View style={[styles.trackBackground, {backgroundColor: colors.timelineBase}]} />
Â  Â  Â  Â  <View style={[styles.trackFill, { width: `${localProgress * 100}%`, backgroundColor: colors.timelineFill }]} />
Â  Â  Â  Â  {localProgress > 0 && localProgress < 1 && (<View style={[styles.thumb, { right: `${localProgress * 100}%`, backgroundColor: colors.timelineFill }]} />)}
Â  Â  Â  </View>
Â  Â  </View>
Â  );
};

export default function PlayerScreen() {
Â  const router = useRouter();
Â  const params = useLocalSearchParams();Â 
Â  const surahId = parseInt(params.surahId) || 1;Â 
Â  const initialAyah = params.initialAyah ? parseInt(Array.isArray(params.initialAyah) ? params.initialAyah[0] : params.initialAyah) : null;

Â  const surahData = getSurahData(surahId);

Â  const [fontsLoaded] = useFonts({
Â  Â  'AlMushaf': require('../assets/fonts/AlMushaf.ttf'),
Â  Â  'AlmendraSC': require('../assets/fonts/AlmendraSC.ttf'),
Â  });

Â  const [fontSize, setFontSize] = useState(28);
Â  const [isDarkMode, setIsDarkMode] = useState(false);
Â  const [showSettings, setShowSettings] = useState(false);

Â  const COLORS = isDarkMode ? DARK_THEME : LIGHT_THEME;

Â  const [position, setPosition] = useState(0);Â 
Â  const [activeAyahId, setActiveAyahId] = useState(null);
Â  const [isPlaying, setIsPlaying] = useState(false);
Â Â 
Â  const hasStartedPlaying = useRef(false);
Â  const ignoreStatusUpdate = useRef(true);Â 

Â  const soundRef = useRef(null);
Â  const isDragging = useRef(false);
Â  const lastSeekTime = useRef(0);
Â  const scrollViewRef = useRef(null);
Â  const ayahPositions = useRef({});Â 
Â  const hasScrolledToInitial = useRef(false);Â 

Â  if (!surahData) return null;
Â  if (!fontsLoaded) return <View style={{flex:1, backgroundColor: COLORS.background}} />;

Â  const safeAudio = async (operation) => {
Â  Â  if (!soundRef.current) return;
Â  Â  try { await operation(); } catch (e) {}
Â  };

Â  const saveProgress = async (id) => {
Â  Â  try {
Â  Â  Â  const verseNumber = id - 1;Â 
Â  Â  Â  const dataToSave = {
Â  Â  Â  Â  surahId: surahId,
Â  Â  Â  Â  nameEn: surahData.nameEn || "Surah " + surahId,Â 
Â  Â  Â  Â  ayahDisplay: verseNumber,
Â  Â  Â  Â  verseId: id
Â  Â  Â  };
Â  Â  Â  await AsyncStorage.setItem('last_read', JSON.stringify(dataToSave));
Â  Â  } catch (e) {
Â  Â  Â  console.log('Failed to save progress', e);
Â  Â  }
Â  };

Â  // ğŸ› ï¸ FORCE STATE UPDATE ON LOAD
Â  useEffect(() => {
Â  Â  if (initialAyah) {
Â  Â  Â  setActiveAyahId(initialAyah);
Â  Â  Â  hasScrolledToInitial.current = false;
Â  Â  }
Â  }, [initialAyah]);

Â  useEffect(() => {
Â  Â  async function initAudio() {
Â  Â  Â  try {
Â  Â  Â  Â  if (soundRef.current) { await soundRef.current.unloadAsync(); }

Â  Â  Â  Â  await Audio.setAudioModeAsync({
Â  Â  Â  Â  Â  allowsRecordingIOS: false,Â 
Â  Â  Â  Â  Â  playsInSilentModeIOS: true,Â 
Â  Â  Â  Â  Â  staysActiveInBackground: true,Â 
Â  Â  Â  Â  Â  shouldDuckAndroid: true,Â 
Â  Â  Â  Â  Â  playThroughEarpieceAndroid: false,
Â  Â  Â  Â  });

Â  Â  Â  Â  let startPosition = 0;
Â  Â  Â  Â  if (initialAyah && surahData) {
Â  Â  Â  Â  Â  const targetVerse = surahData.verses.find(v => v.id === initialAyah);
Â  Â  Â  Â  Â  if (targetVerse) {
Â  Â  Â  Â  Â  Â  startPosition = targetVerse.start;
Â  Â  Â  Â  Â  Â  setActiveAyahId(initialAyah);
Â  Â  Â  Â  Â  Â  ignoreStatusUpdate.current = true;Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  ignoreStatusUpdate.current = false;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  const { sound } = await Audio.Sound.createAsync(
Â  Â  Â  Â  Â  { uri: surahData.audioUrl },
Â  Â  Â  Â  Â  { shouldPlay: false, positionMillis: startPosition, progressUpdateIntervalMillis: 30 }Â 
Â  Â  Â  Â  );
Â  Â  Â  Â Â 
Â  Â  Â  Â  soundRef.current = sound;
Â  Â  Â  Â  setIsPlaying(false);
Â  Â  Â  Â  hasStartedPlaying.current = false;

Â  Â  Â  Â  sound.setOnPlaybackStatusUpdate((status) => {
Â  Â  Â  Â  Â  if (status.isLoaded && !isDragging.current) {
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (ignoreStatusUpdate.current && !status.isPlaying && status.positionMillis < 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â return;Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â if (status.isPlaying || status.positionMillis > 100) {
Â  Â  Â  Â  Â  Â  Â  Â  Â ignoreStatusUpdate.current = false;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â if (status.isPlaying !== isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  setIsPlaying(status.isPlaying);
Â  Â  Â  Â  Â  Â  Â  Â  if (status.isPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasStartedPlaying.current = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â setPosition(status.positionMillis);
Â  Â  Â  Â  Â  Â  Â highlightAyah(status.positionMillis, status.isPlaying);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  } catch (error) { console.log(error); }
Â  Â  }
Â  Â  initAudio();
Â  Â  return () => { if (soundRef.current) soundRef.current.unloadAsync(); };
Â  // ğŸ› ï¸ ADDED initialAyah TO DEPENDENCIES
Â  }, [surahId, initialAyah]);Â 

Â  const highlightAyah = (time, currentlyPlaying) => {
Â  Â  const ayah = surahData.verses.find(w => time >= w.start && time < w.end);
Â  Â  if (ayah && ayah.id !== activeAyahId) {Â 
Â  Â  Â  Â  setActiveAyahId(ayah.id);Â 
Â  Â  Â  Â  if (currentlyPlaying || hasStartedPlaying.current) {
Â  Â  Â  Â  Â  Â  saveProgress(ayah.id);
Â  Â  Â  Â  }
Â  Â  }
Â  };

Â  const scrollToActive = (id) => {
Â  Â  if (id && scrollViewRef.current && ayahPositions.current[id] !== undefined) {
Â  Â  Â  const y = ayahPositions.current[id];
Â  Â  Â  scrollViewRef.current.scrollTo({ y: Math.max(0, y - 150), animated: true });
Â  Â  }
Â  };

Â  useEffect(() => {
Â  Â  scrollToActive(activeAyahId);
Â  }, [activeAyahId]);Â 

Â  const handleSeek = (targetTime) => {
Â  Â  setPosition(targetTime);
Â  Â  ignoreStatusUpdate.current = false;Â 
Â  Â  isDragging.current = true;
Â  Â  const now = Date.now();
Â  Â  if (now - lastSeekTime.current > 70) {
Â  Â  Â  lastSeekTime.current = now;
Â  Â  Â  safeAudio(async () => {
Â  Â  Â  Â  await soundRef.current.setPositionAsync(targetTime);
Â  Â  Â  Â  if (!isPlaying) await soundRef.current.playAsync();Â 
Â  Â  Â  });
Â  Â  }
Â  Â  if (window.dragTimeout) clearTimeout(window.dragTimeout);
Â  Â  window.dragTimeout = setTimeout(() => { isDragging.current = false; }, 200);
Â  };

Â  const playAyah = async (startTime) => {
Â  Â  ignoreStatusUpdate.current = false;Â 
Â  Â  setPosition(startTime);
Â  Â  const ayah = surahData.verses.find(w => startTime >= w.start && startTime < w.end);
Â  Â  if (ayah) {
Â  Â  Â  Â  setActiveAyahId(ayah.id);
Â  Â  Â  Â  saveProgress(ayah.id);Â 
Â  Â  }

Â  Â  safeAudio(async () => {
Â  Â  Â  await soundRef.current.setPositionAsync(startTime);
Â  Â  Â  await soundRef.current.playAsync();
Â  Â  Â  setIsPlaying(true);
Â  Â  Â  hasStartedPlaying.current = true;
Â  Â  });
Â  };

Â  const togglePlayPause = async () => {
Â  Â  ignoreStatusUpdate.current = false;
Â  Â  if (!soundRef.current) return;
Â  Â  const status = await soundRef.current.getStatusAsync();
Â  Â  if (status.isLoaded) {
Â  Â  Â  Â  if (status.isPlaying) { await soundRef.current.pauseAsync(); }Â 
Â  Â  Â  Â  else { await soundRef.current.playAsync(); }
Â  Â  }
Â  };

Â  const skipAyah = (direction) => {
Â  Â  ignoreStatusUpdate.current = false;
Â  Â  const currentIndex = surahData.verses.findIndex(v => v.id === activeAyahId);
Â  Â  if (currentIndex === -1 && surahData.verses.length > 0) { playAyah(surahData.verses[0].start); return; }
Â  Â  let newIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
Â  Â  if (newIndex >= 0 && newIndex < surahData.verses.length) {
Â  Â  Â  Â  playAyah(surahData.verses[newIndex].start);
Â  Â  }
Â  };

Â  const changeSurah = (direction) => {
Â  Â  const newId = direction === 'next' ? surahId + 1 : surahId - 1;
Â  Â  if (newId > 0 && newId <= 114) { router.replace({ pathname: '/player', params: { surahId: newId } }); }
Â  };

Â  return (
Â  Â  <SafeAreaView style={[styles.mainContainer, { backgroundColor: COLORS.background }]}>
Â  Â  Â Â 
Â  Â  Â  <Stack.Screen options={{ headerShown: false }} />

Â  Â  Â  <View style={[styles.header, { borderBottomColor: isDarkMode ? '#333' : '#EEE' }]}>
Â  Â  Â  Â  <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
Â  Â  Â  Â  Â  Â <Text style={{ color: COLORS.primary, fontSize: 16, fontWeight: 'bold' }}>â† Back</Text>
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <Text style={[styles.surahName, { color: COLORS.primary }]}>{surahData.nameAr}</Text>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <TouchableOpacity onPress={() => setShowSettings(!showSettings)} style={styles.aaButton}>
Â  Â  Â  Â  Â  Â <Text style={{ fontSize: 18, fontWeight: 'bold', color: COLORS.primary }}>Aa</Text>
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  </View>

Â  Â  Â  {showSettings && (
Â  Â  Â  Â  <View style={[styles.settingsPanel, { backgroundColor: COLORS.controlBg, borderColor: COLORS.primary }]}>
Â  Â  Â  Â  Â  Â <View style={styles.settingRow}>
Â  Â  Â  Â  Â  Â  Â <Text style={{color: COLORS.text, marginRight: 10}}>Size</Text>
Â  Â  Â  Â  Â  Â  Â <TouchableOpacity onPress={() => setFontSize(Math.max(20, fontSize - 2))} style={styles.sizeBtn}><Text style={{color: COLORS.text}}>-</Text></TouchableOpacity>
Â  Â  Â  Â  Â  Â  Â <Text style={{color: COLORS.text, width: 30, textAlign: 'center'}}>{fontSize}</Text>
Â  Â  Â  Â  Â  Â  Â <TouchableOpacity onPress={() => setFontSize(Math.min(50, fontSize + 2))} style={styles.sizeBtn}><Text style={{color: COLORS.text}}>+</Text></TouchableOpacity>
Â  Â  Â  Â  Â  Â </View>
Â  Â  Â  Â  Â  Â <View style={styles.settingDivider} />
Â  Â  Â  Â  Â  Â <View style={styles.settingRow}>
Â  Â  Â  Â  Â  Â  Â <Text style={{color: COLORS.text, marginRight: 10}}>Mode</Text>
Â  Â  Â  Â  Â  Â  Â <TouchableOpacity onPress={() => setIsDarkMode(!isDarkMode)} style={[styles.modeBtn, {backgroundColor: isDarkMode ? COLORS.primary : '#EEE'}]}>
Â  Â  Â  Â  Â  Â  Â  Â  <Ionicons name={isDarkMode ? "moon" : "sunny"} size={18} color={isDarkMode ? '#FFF' : '#555'} />
Â  Â  Â  Â  Â  Â  Â </TouchableOpacity>
Â  Â  Â  Â  Â  Â </View>
Â  Â  Â  Â  </View>
Â  Â  Â  )}

Â  Â  Â  <ScrollView ref={scrollViewRef} contentContainerStyle={styles.scrollContent}>
Â  Â  Â  Â  {surahData.verses.map((ayah) => {
Â  Â  Â  Â  Â  const isActive = activeAyahId === ayah.id;
Â  Â  Â  Â  Â  const isIstiadha = ayah.id === 1;
Â  Â  Â  Â  Â  const isBasmalah = ayah.id === 2;
Â  Â  Â  Â  Â  const verseNumber = ayah.id - 1;Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  return (
Â  Â  Â  Â  Â  Â  <View key={ayah.id} style={[styles.ayahContainer, {backgroundColor: isActive ? COLORS.highlight : 'transparent'}]}
Â  Â  Â  Â  Â  Â  Â  onLayout={(event) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ayahPositions.current[ayah.id] = event.nativeEvent.layout.y;
Â  Â  Â  Â  Â  Â  Â  Â  if (initialAyah && ayah.id === initialAyah && !hasScrolledToInitial.current) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollToActive(initialAyah);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasScrolledToInitial.current = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  <TouchableOpacity activeOpacity={0.8} onPress={() => playAyah(ayah.start)}>
Â  Â  Â  Â  Â  Â  Â  Â  <Text style={[
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  styles.arabicText,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { fontFamily: 'AlMushaf', fontSize: fontSize, color: isActive ? COLORS.primary : COLORS.text, lineHeight: fontSize * 2 }
Â  Â  Â  Â  Â  Â  Â  Â  Â  ]}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  {ayah.text}Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  {!isIstiadha && !isBasmalah && (<Text style={{ fontFamily: 'AlmendraSC', fontSize: fontSize * 0.8, color: COLORS.brackets }}> Â ï´¿{verseNumber}ï´¾</Text>)}
Â  Â  Â  Â  Â  Â  Â  Â  </Text>
Â  Â  Â  Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  Â  Â  Â  <AyahTimeline ayah={ayah} currentPosition={position} onSeek={handleSeek} colors={COLORS} />
Â  Â  Â  Â  Â  Â  </View>
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  })}
Â  Â  Â  </ScrollView>

Â  Â  Â  <View style={[styles.controlBar, { backgroundColor: COLORS.controlBg, borderColor: isDarkMode ? '#333' : '#F2E8D5' }]}>
Â  Â  Â  Â  <TouchableOpacity style={styles.smallBtn} onPress={() => changeSurah('next')}>
Â  Â  Â  Â  Â  Â <Ionicons name="play-skip-back-outline" size={20} color={COLORS.secondaryText} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  <TouchableOpacity style={styles.controlBtn} onPress={() => skipAyah('next')}>
Â  Â  Â  Â  Â  Â <Ionicons name="play-back" size={28} color={COLORS.primary} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  <TouchableOpacity style={[styles.playBtn, {backgroundColor: COLORS.primary}]} onPress={togglePlayPause}>
Â  Â  Â  Â  Â  Â <Ionicons name={isPlaying ? "pause" : "play"} size={36} color="#FFF" style={{marginLeft: isPlaying ? 0 : 4}} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  <TouchableOpacity style={styles.controlBtn} onPress={() => skipAyah('prev')}>
Â  Â  Â  Â  Â  Â <Ionicons name="play-forward" size={28} color={COLORS.primary} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  Â  <TouchableOpacity style={styles.smallBtn} onPress={() => changeSurah('prev')}>
Â  Â  Â  Â  Â  Â <Ionicons name="play-skip-forward-outline" size={20} color={COLORS.secondaryText} />
Â  Â  Â  Â  </TouchableOpacity>
Â  Â  Â  </View>
Â  Â  </SafeAreaView>
Â  );
}

const styles = StyleSheet.create({
Â  mainContainer: { flex: 1 },
Â  scrollContent: { paddingHorizontal: 20, paddingTop: 10, paddingBottom: 150 },Â 
Â  header: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 20, paddingVertical: 15, borderBottomWidth: 1 },
Â  backButton: { padding: 10 },
Â  aaButton: { padding: 10, borderWidth: 1, borderColor: '#DDD', borderRadius: 8 },
Â  surahName: { fontFamily: 'AlMushaf', fontSize: 26 },
Â Â 
Â  settingsPanel: {
Â  Â  position: 'absolute', top: 70, right: 20, width: 150, zIndex: 100,
Â  Â  borderRadius: 12, borderWidth: 1, padding: 15,
Â  Â  shadowColor: "#000", shadowOffset: {width:0, height:2}, shadowOpacity:0.2, shadowRadius:5, elevation:5
Â  },
Â  settingRow: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 5 },
Â  settingDivider: { height: 1, backgroundColor: '#EEE', marginVertical: 10 },
Â  sizeBtn: { padding: 5, backgroundColor: '#EEE', borderRadius: 5, width: 30, alignItems: 'center' },
Â  modeBtn: { padding: 8, borderRadius: 20 },

Â  ayahContainer: { marginBottom: 5, width: '100%', paddingVertical: 12, paddingHorizontal: 5, borderRadius: 15 },
Â  arabicText: { textAlign: 'center', writingDirection: 'rtl' },
Â  timelineWrapper: { height: 30, justifyContent: 'center', width: '80%', alignSelf: 'center', marginTop: 5 },
Â  trackArea: { height: 30, justifyContent: 'center', width: '100%' },
Â  trackBackground: { height: 3, borderRadius: 1.5, width: '100%', position: 'absolute' },
Â  trackFill: { height: 3, borderRadius: 1.5, position: 'absolute', right: 0 },Â 
Â  thumb: { width: 12, height: 12, borderRadius: 6, position: 'absolute', marginRight: -6, borderWidth: 2, borderColor: '#fff' },
Â Â 
Â  controlBar: {
Â  Â  position: 'absolute', bottom: 30, left: 20, right: 20,
Â  Â  height: 75, borderRadius: 25,
Â  Â  flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between',
Â  Â  paddingHorizontal: 20,
Â  Â  shadowColor: "#000", shadowOffset: {width: 0, height: 5}, shadowOpacity: 0.15, shadowRadius: 10, elevation: 5,
Â  Â  borderWidth: 1
Â  },
Â  controlBtn: { padding: 10 },
Â  smallBtn: { padding: 10, opacity: 0.7 },
Â  playBtn: {
Â  Â  width: 55, height: 55, borderRadius: 27.5,
Â  Â  justifyContent: 'center', alignItems: 'center',
Â  Â  shadowColor: '#000', shadowOffset: {width: 0, height: 4}, shadowOpacity: 0.2, shadowRadius: 5
Â  }
});

registry.tsÂ 

import surah1 from './surah_1';
import surah2 from './surah_2';

// This map allows us to look up data instantly by ID
const SURAH_REGISTRY = {
Â  1: surah1,
Â  2: surah2,
};

export const getSurahData = (id) => {
Â  return SURAH_REGISTRY[id] || null;
};

app.json

{
Â  "expo": {
Â  Â  "name": "QuranApp",
Â  Â  "slug": "quran-app",
Â  Â  "version": "1.0.0",
Â  Â  "orientation": "portrait",
Â  Â  "icon": "./assets/images/icon.png",
Â  Â  "scheme": "myapp",
Â  Â  "userInterfaceStyle": "automatic",
Â  Â  "splash": {
Â  Â  Â  "image": "./assets/images/splash.png",
Â  Â  Â  "resizeMode": "contain",
Â  Â  Â  "backgroundColor": "#ffffff"
Â  Â  },
Â  Â  "ios": {
Â  Â  Â  "supportsTablet": true,
Â  Â  Â  "bundleIdentifier": "com.yourname.quranapp",
Â  Â  Â  "infoPlist": {
Â  Â  Â  Â  "UIBackgroundModes": ["audio"]
Â  Â  Â  }
Â  Â  },
Â  Â  "android": {
Â  Â  Â  "adaptiveIcon": {
Â  Â  Â  Â  "foregroundImage": "./assets/images/adaptive-icon.png",
Â  Â  Â  Â  "backgroundColor": "#ffffff"
Â  Â  Â  },
Â  Â  Â  "package": "com.yourname.quranapp",
Â  Â  Â  "permissions": ["WAKE_LOCK"]
Â  Â  },
Â  Â  "web": {
Â  Â  Â  "bundler": "metro",
Â  Â  Â  "output": "static",
Â  Â  Â  "favicon": "./assets/images/favicon.png"
Â  Â  },
Â  Â  "plugins": [
Â  Â  Â  "expo-router",
Â  Â  Â  "expo-font"
Â  Â  ],
Â  Â  "experiments": {
Â  Â  Â  "typedRoutes": true
Â  Â  }
Â  }
}

please let me know if you want to review some thing else